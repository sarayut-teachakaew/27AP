<!DOCTYPE html>
<html>
<head>
    <title>27AP</title>
    <style>
        canvas {
            position:fixed;
            left:0;
            top:0;
            width:100%;
            height:100%;
        }
    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script src="player.js"></script>
    <script>
        var socket = io();
        var myCanvas;
        var getPara = parseURLParams(document.URL);
        var keys= [];
        var name=getPara.name;
        console.log("NAME : "+name);
        let ply = new Player(name,0,0,new Date().getMilliseconds());
        ply.visible=true;
        var players = {};
        players[ply.id]=ply;
        socket.emit('player connect',{id:ply.id , name:ply.name});
    
        document.addEventListener('keydown', (event) => {
            keys[event.keyCode]=true;
        })
        document.addEventListener('keyup', (event) => {
            keys[event.keyCode]=false;
        })
        
        socket.on('load game', function(data){
            console.log("Loading...");
            //console.log(data.player);
            data.player.forEach(play => {
                players[play.id] = new Player(play.name,0,0,play.id);
            });
            console.log("COMPELTE");
        });
        socket.on('player connect', function(play){
            if(play.id == ply.id)return;
            players[play.id] = new Player(play.name,0,0,play.id);
        });
        socket.on('player disconnect', function(id){
            delete players[id];
        });

        socket.on('shared data', function(data){
            if(data.player.id in players){
            if(data.player.id != ply.id){
                players[data.player.id].x = data.player.x;
                players[data.player.id].y = data.player.y;
                players[data.player.id].visible = true;
            }return;}
            //players[data.player.id] = new Player('',data.player.x,data.player.y,data.player.id);
        });

        function update(){
            if(keys[87])ply.push(0,-5);//W
            if(keys[83])ply.push(0,5);//S
            if(keys[65])ply.push(-5,0);//A
            if(keys[68])ply.push(5,0);//D
            ply.update();
            socket.emit('shared data',{player:{x:ply.x, y:ply.y, id:ply.id}});

            myCanvas.width = window.innerWidth;
            myCanvas.height = window.innerHeight;

            for(var key in players){
                players[key].draw(myCanvas);
            }
        }
        setInterval(update, 33);

        function parseURLParams(url) {
            var queryStart = url.indexOf("?") + 1,
            queryEnd   = url.indexOf("#") + 1 || url.length + 1,
            query = url.slice(queryStart, queryEnd - 1),
            pairs = query.replace(/\+/g, " ").split("&"),
            parms = {}, i, n, v, nv;

            if (query === url || query === "") return;

            for (i = 0; i < pairs.length; i++) {
                nv = pairs[i].split("=", 2);
                n = decodeURIComponent(nv[0]);
                v = decodeURIComponent(nv[1]);
                
                if (!parms.hasOwnProperty(n)) parms[n] = [];
                parms[n].push(nv.length === 2 ? v : null);
            }
            return parms;
        }
    </script>
</head>
<body>
    <canvas id="myCanvas" width="1280" height="720"></canvas>
    <script>
        myCanvas = document.getElementById("myCanvas");
    </script>
</body>
</html>